#!/usr/bin/env bash
# uninstall_xray_service.sh — безопасное удаление только API-агента,
# без удаления Xray и баз данных. Действующие VPN-подключения сохранятся.

set -euo pipefail

# ------------------------------------------------------------------
# 1. Проверки
# ------------------------------------------------------------------
if [[ ${EUID:-0} -ne 0 ]]; then
  echo "Пожалуйста, запускайте скрипт от root." >&2
  exit 1
fi

# Пути и имена, используемые install.sh
SERVICE_NAME="wg-service.service"
SERVICE_UNIT="/etc/systemd/system/${SERVICE_NAME}"
ENV_FILE="/etc/wg-service.env"
VENV_DIRS=(
  "/opt/xray_service_venv"   # используется основным install.sh
  "/opt/wg_service_venv"     # старый вариант (wireguard_old)
)

TARGET_FILES=(
  "/opt/wg_service.py"
  "/opt/install.sh"
)

# ------------------------------------------------------------------
# 2. Остановка и отключение systemd-юнита API
# ------------------------------------------------------------------
echo "==> Останавливаю и отключаю сервис ${SERVICE_NAME} (если запущен)…"
if systemctl list-unit-files | grep -q "^${SERVICE_NAME}"; then
  systemctl disable --now "${SERVICE_NAME}" || true
fi

# ------------------------------------------------------------------
# 3. Удаление unit-файла и env-файла
# ------------------------------------------------------------------
echo "==> Удаляю unit-файл и env-файл (если существуют)…"
if [[ -f "${SERVICE_UNIT}" ]]; then
  rm -f "${SERVICE_UNIT}"
fi

if [[ -f "${ENV_FILE}" ]]; then
  rm -f "${ENV_FILE}"
fi

echo "==> Перечитываю конфигурацию systemd…"
systemctl daemon-reload || true

# ------------------------------------------------------------------
# 4. Удаление виртуальных окружений агента
# ------------------------------------------------------------------
echo "==> Удаляю виртуальные окружения Python (если есть)…"
for venv in "${VENV_DIRS[@]}"; do
  if [[ -d "${venv}" ]]; then
    rm -rf "${venv}"
  fi
done

# ------------------------------------------------------------------
# 5. Удаление служебных файлов из /opt
# ------------------------------------------------------------------
echo "==> Удаляю служебные файлы (/opt/wg_service.py, /opt/install.sh), если есть…"
for f in "${TARGET_FILES[@]}"; do
  if [[ -e "${f}" ]]; then
    rm -f "${f}"
  fi
done

# ------------------------------------------------------------------
# 6. Что намеренно НЕ удаляем
# ------------------------------------------------------------------
# - Xray и его конфиг /usr/local/etc/xray/config.json — не трогаем, чтобы клиенты
#   продолжали подключаться по уже выданным конфигам.
# - MariaDB/MySQL, БД и пользователи — не удаляем, чтобы сохранить профили.
# - Фаерволл-правила для Xray-порта — не меняем.

echo "------------------------------------------------------------"
echo "✅  Удаление агента завершено."
echo "   Xray и базы данных не затронуты. Текущие VPN-подключения продолжают работать."
echo
echo "   Чтобы установить/обновить код заново, запустите ваш install.sh."
echo "   Логи Xray: journalctl -u xray -f"
echo "------------------------------------------------------------"

# ------------------------------------------------------------------
# 7. Самоуничтожение скрипта (удаляем файл самого uninstall.sh)
# ------------------------------------------------------------------
# Пытаемся определить абсолютный путь к скрипту; если не удалось — пробуем удалить по $0
SELF_PATH="$(readlink -f "$0" 2>/dev/null || realpath "$0" 2>/dev/null || echo "$0")"
if [[ -n "$SELF_PATH" && -e "$SELF_PATH" ]]; then
  rm -f -- "$SELF_PATH" || true
else
  rm -f -- "$0" || true
fi


